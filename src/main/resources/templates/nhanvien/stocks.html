<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh sách cổ phiếu</title>
    <link rel="stylesheet" th:href="@{/css/stocks.css}">
</head>
<body>
<div>
    <div class="toolbar">
        <a href="#" onclick="showSubform('add'); return false;">Thêm</a> |
        <a th:href="@{/stocks}">Reload</a> |
        <form th:action="@{/stocks/search}" method="post" style="display: inline;">
            <input type="text" name="query" placeholder="Tìm kiếm...">
            <button type="submit">Tìm</button>
        </form> |
        <a th:href="@{/nhanvien}">Thoát</a>
    </div>

    <table class="table">
        <thead>
        <tr>
            <th>Mã CP</th>
            <th>Tên công ty</th>
            <th>Địa chỉ</th>
            <th>Số lượng phát hành</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="stock : ${stocks.content}">
            <td th:text="${stock.maCP}"></td>
            <td th:text="${stock.tenCty}"></td>
            <td th:text="${stock.diaChi}"></td>
            <td th:text="${stock.soLuongPH}"></td>
            <td>
                <a href="@{/stocks(action='edit', maCP=${stock.maCP})}" class="edit-link" th:attr="data-maCP=${stock.maCP}">Ghi</a> |
                <form th:action="@{/stocks/delete/{maCP}(maCP=${stock.maCP})}" method="post" style="display:inline;">
                    <button type="submit" onclick="return confirm('Bạn có chắc muốn xóa?')">Xóa</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Phân trang -->
    <div class="pagination">
        <span th:if="${stocks.hasPrevious()}">
            <a th:href="@{/stocks(page=${stocks.number - 1})}">« Trước</a>
        </span>
        <span th:each="i : ${#numbers.sequence(0, stocks.totalPages - 1)}">
            <a th:href="@{/stocks(page=${i})}"
               th:text="${i + 1}"
               th:classappend="${i == stocks.number} ? 'active'"></a>
        </span>
        <span th:if="${stocks.hasNext()}">
            <a th:href="@{/stocks(page=${stocks.number + 1})}">Sau »</a>
        </span>
    </div>

    <!-- Subform -->
    <div id="subform" class="subform-container">
        <h3 id="subform-title"></h3>
        <form id="stock-form" th:action="@{/stocks/add}" th:object="${stock}" method="post">
            <table class="subform-table">
                <tr>
                    <td><label>Mã cổ phiếu:</label></td>
                    <td><input type="text" th:field="*{maCP}" id="maCP" /></td>
                </tr>
                <tr>
                    <td><label>Tên công ty:</label></td>
                    <td><input type="text" th:field="*{tenCty}" /></td>
                </tr>
                <tr>
                    <td><label>Địa chỉ:</label></td>
                    <td><input type="text" th:field="*{diaChi}" /></td>
                </tr>
                <tr>
                    <td><label>Số lượng phát hành:</label></td>
                    <td><input type="text" th:field="*{soLuongPH}" /></td>
                </tr>
            </table>

            <div class="form-actions">
                <button type="submit">Lưu</button>
                <button type="button" onclick="hideSubform()">Hủy</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Log khi trang tải xong
        console.log("Trang đã tải xong, sẵn sàng xử lý sự kiện.");

        // Log khi nhấn nút "Ghi" để sửa
        document.querySelectorAll(".edit-link").forEach(function (link) {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                const maCP = this.getAttribute("data-maCP");
                console.log("Nhấn 'Ghi', Mã CP được chọn để sửa:", maCP);
                showSubform('edit', maCP);
            });
        });

        // Log khi biểu mẫu được gửi
        document.getElementById("stock-form").addEventListener("submit", function(e) {
            const maCP = document.getElementById("maCP").value;
            console.log("Biểu mẫu được gửi, Mã CP (input):", maCP);
            console.log("Action của form:", this.action);
            // SỬA: Bỏ log cho maCPHidden vì trường ẩn đã bị xóa
        });
    });

    function showSubform(action, maCP = '') {
        const subform = document.getElementById('subform');
        const title = document.getElementById('subform-title');
        const form = document.getElementById('stock-form');
        const maCPInput = document.getElementById('maCP');
        // SỬA: Bỏ biến maCPHidden vì không còn trường ẩn

        subform.classList.add('active');
        form.reset();

        if (action === 'add') {
            title.textContent = 'Thêm cổ phiếu';
            form.action = '/stocks/add';
            maCPInput.disabled = false;
            maCPInput.value = '';
            console.log("Mở subform để thêm, Mã CP được reset thành rỗng.");
            // SỬA: Bỏ gán giá trị cho maCPHidden
        } else if (action === 'edit') {
            title.textContent = 'Sửa cổ phiếu';
            form.action = '/stocks/edit/' + maCP;
            maCPInput.disabled = true;
            maCPInput.value = maCP;
            console.log("Mở subform để sửa, Mã CP được gán:", maCP);
            // SỬA: Bỏ gán giá trị cho maCPHidden, maCP được gửi qua URL
        }
    }

    function hideSubform() {
        document.getElementById('subform').classList.remove('active');
        console.log("Đóng subform.");
    }
</script>
</body>
</html>