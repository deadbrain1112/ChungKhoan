<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sao lưu - Phục hồi</title>
    <link rel="stylesheet" href="/css/backup.css">
    <style>
        .alert-success { color: green; }
        .alert-error { color: red; }
        .menu-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .inline-form { display: inline-block; }
        .content { display: flex; }
        .left-panel { width: 20%; }
        .main-panel { width: 80%; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
<div class="container">
    <!-- Hiển thị thông báo -->
    <div th:if="${msg}" class="alert" th:class="${msg.contains('thành công') ? 'alert-success' : 'alert-error'}">
        <span th:text="${msg}"></span>
    </div>
    <div th:if="${errorMsg}" class="alert alert-error">
        <span th:text="${errorMsg}"></span>
    </div>

    <!-- Thanh menu chức năng -->
    <div class="menu-bar">
        <!-- Form sao lưu -->
        <form th:action="@{/backup/save}" method="post" class="inline-form"
              onsubmit="return confirm('Bạn có chắc muốn sao lưu cơ sở dữ liệu này?');">
            <input type="hidden" name="dbName" th:value="${selectedDb}" />
            <label>
                <input type="checkbox" name="deleteOld">
                Xóa bản sao lưu cũ trước khi sao lưu mới
            </label>
            <button type="submit" th:disabled="${selectedDb == null}">Sao lưu</button>
        </form>

        <!-- Form phục hồi -->
        <form th:action="@{/backup/recovery}" method="post" class="inline-form recovery-form"
              onsubmit="return confirm('Bạn có chắc muốn phục hồi cơ sở dữ liệu này? Hành động này không thể hoàn tác.');">
            <input type="hidden" name="dbName" th:value="${selectedDb}" />
            <label>
                <input type="checkbox" id="timeRecoveryCheckbox" name="enableTimeRecovery" value="true"
                       onchange="toggleTimeInputs()">
                Phục hồi theo thời gian
            </label>
            <div id="timeRecoveryInputs" style="display: none; margin-top: 10px;">
                <label>Ngày:</label>
                <input type="date" name="recoveryDate"><br><br>
                <label>Giờ:</label>
                <input type="time" name="recoveryTime" step="1"><br><br>
                <p class="note">
                    Ngày giờ nhập vào là thời điểm muốn phục hồi cơ sở dữ liệu.<br>
                    Thời điểm này phải sau bản sao lưu đã chọn và trước hiện tại ít nhất 1 phút.
                </p>
            </div>
            <button type="submit" th:disabled="${selectedDb == null}">Phục hồi</button>
        </form>

        <!-- Form tạo device sao lưu -->
        <form th:action="@{/backup/device-create}" method="post" class="inline-form"
              onsubmit="return confirm('Bạn có chắc muốn tạo thiết bị sao lưu cho cơ sở dữ liệu này?');">
            <input type="hidden" name="dbName" th:value="${selectedDb}" />
            <button type="submit" th:disabled="${selectedDb == null}">Tạo device sao lưu</button>
        </form>

        <!-- Form xóa toàn bộ sao lưu -->
        <form th:action="@{/backup/delete-all}" method="post" class="inline-form"
              onsubmit="return confirm('Bạn có chắc muốn xóa toàn bộ sao lưu? Hành động này không thể hoàn tác.');">
            <button type="submit">Xóa toàn bộ sao lưu</button>
        </form>
    </div>

    <div class="content">
        <div class="left-panel">
            <h3>Cơ sở dữ liệu</h3>
            <ul>
                <li th:each="db : ${databases}">
                    <form th:action="@{/backup}" method="get">
                        <input type="hidden" name="dbName" th:value="${db}" />
                        <button type="submit" th:text="${db}" class="db-btn"></button>
                    </form>
                </li>
            </ul>
        </div>

        <div class="main-panel">
            <table>
                <thead>
                <tr>
                    <th>Bản sao lưu thứ #</th>
                    <th>Diễn giải</th>
                    <th>Ngày giờ sao lưu</th>
                    <th>User sao lưu</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="b : ${backupList}">
                    <td th:text="${b.position}"></td>
                    <td th:text="${b.description}"></td>
                    <td th:text="${b.backupTime}"></td>
                    <td th:text="${b.user}"></td>
                </tr>
                <tr th:if="${backupList == null or backupList.isEmpty}">
                    <td colspan="4">Không có bản sao lưu nào.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function toggleTimeInputs() {
        const checkbox = document.getElementById('timeRecoveryCheckbox');
        const timeInputs = document.getElementById('timeRecoveryInputs');
        timeInputs.style.display = checkbox.checked ? 'block' : 'none';
    }
</script>
</body>
</html>